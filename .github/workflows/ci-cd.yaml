name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - staging
      - main
  workflow_dispatch:

env:
  COMPOSE_DIR: docker
  DEPLOY_SCRIPT: ./scripts/deploy_blue_green.sh
  HEALTHCHECK_SCRIPT: ./scripts/healthcheck.sh

jobs:
  validate:
    name: Validate (Terraform / Security / Compose)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform init (quick)
        working-directory: terraform/envs/dev
        run: terraform init -backend=false

      - name: Terraform validate (all envs)
        run: |
          for d in terraform/envs/*; do
            if [ -d "$d" ]; then
              (cd "$d" && terraform init -backend=false && terraform validate) || exit 1
            fi
          done

      - name: Run tfsec (security scan)
        uses: aquasecurity/tfsec-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tfsec_args: "--exclude-path terraform/envs/dev/.terraform"

      - name: Lint / Validate docker-compose files
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl python3-pip
          sudo pip3 install docker-compose
          docker-compose -f $COMPOSE_DIR/docker-compose.yml config
        working-directory: .

      - name: Save commit diff for later jobs
        id: changes
        run: |
          echo "::set-output name=before::${GITHUB_EVENT_BEFORE:-0000000000000000000000000000000000000000}"
          echo "::set-output name=after::${GITHUB_SHA}"
          git fetch --no-tags --depth=1 origin ${{ github.ref }} || true
          # Detect if terraform/ changed
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^terraform/'; then
            echo "terraform_changed=true" >> $GITHUB_OUTPUT
          else
            echo "terraform_changed=false" >> $GITHUB_OUTPUT
          fi
          # Detect if docker/ or scripts changed (for app deploy)
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | egrep -q '^(docker/|scripts/|.github/workflows/)'; then
            echo "app_changed=true" >> $GITHUB_OUTPUT
          else
            echo "app_changed=false" >> $GITHUB_OUTPUT
          fi

  deploy-infrastructure:
    name: Deploy Infrastructure (Terraform) - ${{ matrix.env }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, staging, prod]
    # Only run infra job when terraform files changed
    if: needs.validate.outputs.terraform_changed == 'true'
    environment: ${{ matrix.env == 'prod' && 'prod' || matrix.env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        working-directory: terraform/envs/${{ matrix.env }}
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/envs/${{ matrix.env }}
        run: terraform plan -var-file=${{ matrix.env }}.tfvars -out=tfplan.binary

      - name: Terraform Apply (auto for non-prod)
        working-directory: terraform/envs/${{ matrix.env }}
        if: matrix.env != 'prod'
        run: terraform apply -auto-approve tfplan.binary

      - name: Terraform Apply (prod - manual approval)
        working-directory: terraform/envs/${{ matrix.env }}
        if: matrix.env == 'prod'
        run: terraform apply -auto-approve tfplan.binary

  deploy-application:
    name: Deploy Application (Blue/Green)
    needs:
      - validate
      - deploy-infrastructure
    runs-on: ubuntu-latest
    if: needs.validate.outputs.app_changed == 'true' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Ensure known hosts contains EC2 host
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.REPO_SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.REPO_SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          fi

      - name: SSH: Create app dir on VM & pull latest code
        run: |
          ssh -o StrictHostKeyChecking=yes ubuntu@${{ secrets.EC2_HOST }} <<'SSH_EOF'
            set -euo pipefail
            cd ~
            mkdir -p takehome-podinfo
            cd takehome-podinfo
            if [ -d .git ]; then
              git fetch --all
              git reset --hard origin/$(git rev-parse --abbrev-ref HEAD || echo main)
            else
              git clone https://github.com/${{ github.repository }} .
            fi
            git checkout ${{ github.ref_name || 'main' }} || true
SSH_EOF

      - name: SSH: Pull latest, run deploy script (choose color)
        env:
          IMAGE_TAG: ${{ secrets.DOCKER_IMAGE_TAG || 'latest' }}
        run: |
          # choose color based on timestamp to alternate (or you can compute from state)
          COLOR=$(python3 - <<'PY'
import sys, os, pathlib
state = pathlib.Path('/home/ubuntu/devops-takehome/docker/.current_color')
if state.exists():
    cur = state.read_text().strip()
    print('green' if cur=='blue' else 'blue')
else:
    print('green')
PY
)
          echo "Deploying color: $COLOR"
          ssh ubuntu@${{ secrets.EC2_HOST }} "cd ~/devops-takehome && git pull origin $(git rev-parse --abbrev-ref HEAD || echo main) && chmod +x $DEPLOY_SCRIPT && $DEPLOY_SCRIPT $COLOR $IMAGE_TAG"

      - name: Wait for app to settle (give services time)
        run: sleep 10

      - name: Run smoke tests (call smoke-tests job)
        uses: actions/github-script@v6
        with:
          script: |
            // trigger the smoke tests job by creating a small API call locally in pipeline later
            // (no-op placeholder; actual smoke tests run below in next job)

  smoke-tests:
    name: Smoke tests (synthetic + metrics)
    needs: deploy-application
    runs-on: ubuntu-latest
    steps:
      - name: Curl frontend root
        run: |
          curl -sSf "http://${{ secrets.EC2_HOST }}/" -o /dev/null
          echo "frontend root ok"

      - name: Curl backend via nginx (/api)
        run: |
          curl -sSf "http://${{ secrets.EC2_HOST }}/api/" -o /dev/null
          echo "backend via nginx ok"

      - name: Check metrics endpoint
        run: |
          curl -sSf "http://${{ secrets.EC2_HOST }}/metrics" -o /dev/null
          echo "metrics ok"

      - name: Check Prometheus scrape (basic)
        run: |
          # query prometheus for target up metric
          PROM_URL="http://${{ secrets.EC2_HOST }}:9090"
          if curl -sSf "${PROM_URL}/-/ready" >/dev/null; then
            echo "prometheus ready"
          else
            echo "prometheus not ready (this is non-fatal)"
          fi

  rollback:
    name: Rollback (manual or auto)
    runs-on: ubuntu-latest
    needs: deploy-application
    if: failure()
    steps:
      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Ensure known hosts contains EC2 host
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.REPO_SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.REPO_SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          fi

      - name: SSH: Run rollback script
        run: |
          ssh ubuntu@${{ secrets.EC2_HOST }} "cd ~/devops-takehome && chmod +x ./scripts/rollback.sh && ./scripts/rollback.sh"
